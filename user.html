<!DOCTYPE html>
<html>
<head>
	<title>Grocery 2.0 | Users</title>
	<meta charset="utf-8" />
	<link rel="icon" type="image/png" href="assets/img/favicon.ico">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<!-- <title>Light Bootstrap Dashboard by Creative Tim</title> -->
	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
	<meta name="viewport" content="width=device-width" />
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
	<!-- Bootstrap core CSS     -->
	<link href="assets/css/bootstrap.min.css" rel="stylesheet" />
	<link href="assets/css/user.css" rel="stylesheet" />

	<!-- Animation library for notifications   -->
	<link href="assets/css/animate.min.css" rel="stylesheet"/>

	<!--  Light Bootstrap Table core CSS    -->
	<link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet"/>


	<!--  CSS for Demo Purpose, don't include it in your project     -->
	<link href="assets/css/demo.css" rel="stylesheet" />


	<!--     Fonts and icons     -->
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
	<link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />
	<link rel="stylesheet" href="http://css-spinners.com/css/spinner/spinner.css" type="text/css">
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/tripledes.js"></script>
	
	<script src="assets/js/jquery-1.10.2.js" type="text/javascript"></script>
	
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
	<script src="assets/js/main.js"></script>
	<script src="assets/js/user.js"></script>
	<script src="assets/js/bootbox.min.js"></script>
	<script type="text/javascript">
		function getQueryParams(qs) {
			qs = qs.split('+').join(' ');

			var params = {},
			tokens,
			re = /[?&]?([^=]+)=([^&]*)/g;

			while (tokens = re.exec(qs)) {
				params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
			}

			return params;
		}
		var username;
		function checkUser(){
			try{
				username = getQueryParams(document.location.search).username.toString();
				username = username.split(':');
				value = username[1];
				username = username[0];
				if(value != 'true'){
					window.location.href = "index.html"
				}
				// console.log(typeof(username));
				findUserForEmail(username, function(user){
					try{
						var isAdmin = user[0].get('isAdmin');
						if(isAdmin != true){
							window.location.href = "index.html";
						}
					}
					catch(e){
						window.location.href='index.html';
					}
				});
			}
			catch(e){
				window.location.href = "index.html"
			}
		}
		checkUser();
		// loginUserForEmail(username)
	</script>
	<style  type="text/css">
		body, p, div, tr, td{
			font-family: 'Montserrat';
		}
		.inputButton, .inputButton:hover {
			background : white !important;
			color: black;
		}
		.userclass {
			text-align: center;
			margin-top: 0.5%;
			margin-left: 40%;
			color: white;
			font-style: bold;
			font-size: 200%;
		}
	</style>
</head>
<body>
	<div class="wrapper">
		<div class="navbar navbar-inverse">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">Grocery 2.0</a>
			</div>
			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav navbar-left">
					<li>
						<a href="dishList.html">
							Dishes
						</a>
					</li>
				</ul>
			<!-- 	<ul class="nav navbar-nav userclass">
					<li>
						<center>Users</center>
					</li>
				</ul> -->
				<ul class="nav navbar-nav navbar-right">
					<li>
						<a href="#" id="admin">Hello Admin <span class="LOGOUT">Logout</span></a>
					</li>
				</ul>
			</div>
		</div>
		<div class="container">

			<!-- Main row dividing right and left part into columns -->
			<div class="row">

				<!-- The left column of dishes starts here -->
				<div class="col-md-4" style="border-right: 1px solid grey">

					<!-- The username modal -->
					<div id="myUserModal" class="modal fade">
						<div class="modal-dialog">
							<div class="modal-content">
								<!-- dialog body -->
								<div class="modal-body">
									<button type="button" class="close" data-dismiss="modal">&times;</button>
									Add User
								</div>
								<!-- dialog buttons -->
								<div class="modal-footer"><button type="button" class="btn btn-primary">OK</button></div>
							</div>
						</div>
					</div>

					<div class="card panel panel-default box-shadow--8dp" id="usersList">
						<table class="table table-hover table-striped">
							<thead>
								<tr>
									<th>
										<b>Users</b>
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td align="center">
										<div class="spinner-loader">
											Loadingâ€¦
										</div>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<!-- The left column containing dishes ends here -->

				<h3 class="headingColor text-right selectedUserTopRight"><b>Selected User</b></h3>

				<!-- Right side column containing vegetables, grocery and spices -->
				<div class="col-md-8 border-bottom">

					<!-- The general Modal used for all -->

					<div class="modal fade" id="suggestionsModal" role="dialog">
						<div class="modal-dialog modal-md">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal">&times;</button>
									<h4 class="modal-title" id="modalTitle">Select Ingredient Type</h4>
								</div>
								<div class="modal-body modalBody">
									<div class="table-responsive">
										<table id="mytable" class="table table-bordred table-striped">
											<thead>
												<tr>
													<th width="10%">
														<input type="checkbox" id="checkall">
													</th>
													<th>
														Name
													</th>
												</tr>
											</thead>
											<tbody class="modalTableBody">
												<tr>
													<td width="10%"><input type="checkbox" class="checkthis"></td>
													<td></td>
												</tr>
											</tbody>
										</table>
										<div class="clearfix"></div>
									</div>
								</div>
								<div class="modal-footer" style="border:0">
									<button type="button" class="btn btn-info selectDishes" data-dismiss="modal">Select</button>
								</div>
							</div>
						</div>
					</div>


					<!-- Vegetables Part start here -->
					<div class="">
						<h3 class="headingColor"><b>Suggestions</b></h3>
					</div>
					<div class="card panel panel-default box-shadow--8dp" id="suggestionsTable">
						<table class="table table-hover table-striped" >
							<thead>
								<tr>
									<th width="80%" class="addNewSuggestions" data-target="suggestionsModal">
										<b>Add New Suggestions<button type="button" class="btn btn-simple btn-xs openModal" data-toggle="modal" data-target="#suggestionsModal"><i class="fa fa-plus text-right"></i></button></b>
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>

								</tr>
							</tbody>
						</table>
					</div>
					<!-- Vegetables part end here -->


					<!-- Grocery Part starts here -->
					<div class="">
						<h3 class="headingColor"><b>Orders</b></h3>
					</div>
					<div class="card panel panel-default box-shadow--8dp" id="ordersTable">
						<table class="table table-hover table-striped" >
							<thead>
								<tr>
									<th width="25%" class="addNewOrder">
										<b>Date</b>
									</th>
									<!-- <th></th> -->

								</tr>
							</thead>
							<tbody>
								<tr>

								</tr>
							</tbody>
						</table>
					</div>
					<div class="row" style="bottom 0px">
						<div class="col-md-5">
						</div>

						<div class="col-md-3">
							<div class="input-group">
								<!--	 <input type="text" class="form-control" placeholder="Comments..."> -->
								<span class="input-group-btn">
									<button class="btn btn-default inputButton" type="button" id="saveButton">Save Suggestions</button>
								</span>
							</div>
						</div>
					</div>
				</div>
				<!-- Right column ends here -->

			</div>
		</div>
	</div>
	<!-- set up the modal to start hidden and fade in and out -->
	
</body>
<!--   Core JS Files   -->
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>


<!--  Checkbox, Radio & Switch Plugins -->
<script src="assets/js/bootstrap-checkbox-radio-switch.js"></script>

<!--  Charts Plugin -->
<script src="assets/js/chartist.min.js"></script>

<!--  Notifications Plugin    -->
<script src="assets/js/bootstrap-notify.js"></script>

<!--  Google Maps Plugin    -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

<!-- Light Bootstrap Table Core javascript and methods for Demo purpose -->
<script src="assets/js/light-bootstrap-dashboard.js"></script>

<!-- Light Bootstrap Table DEMO methods, don't include it in your project! -->
<script src="assets/js/demo.js"></script>
<!-- sometime later, probably inside your on load event callback -->
<script>
//     $("#myModal").on("show", function() {    // wire up the OK button to dismiss the modal when shown
//     	$("#myModal a.btn").on("click", function(e) {
//             console.log("button pressed");   // just as an example...
//             $("#myModal").modal('hide');     // dismiss the dialog
//         });
//     });
//     $("#myModal").on("hide", function() {    // remove the event listeners when the dialog is dismissed
//     	$("#myModal a.btn").off("click");
//     });

//     $("#myModal").on("hidden", function() {  // remove the actual elements from the DOM when fully hidden
//     	$("#myModal").remove();
//     });

//     $("#myUserModal").modal({                    // wire up the actual modal functionality and show the dialog
//     	"backdrop"  : "static",
//     	"keyboard"  : true,
//       "show"      : true                     // ensure the modal is shown immediately
//   });
</script>

<script type="text/javascript">
	$("#checkall").val('off');

	var userObj;
	var currentSuggestedDishes={};
	var currentDishByName = {};
	var currentUser = {};
	var _allSelectDishesForUser;
	var addText = '<td class="td-actions text-right">' + '\n' + '<button data-original-title="" type="button" rel="tooltip" class="btn btn-primary btn-simple btn-xs editUserName noDisplay">' + '\n' + '<i class="fa fa-pencil"></i>' + '\n' + '</button>' + '<button data-original-title="" type="button" rel="tooltip" class="btn btn-danger btn-simple btn-xs deleteUser">' + '\n' + '<i class="fa fa-minus"></i>' + '\n' + '</button>' + '\n' + '</td>';
	var _allUsers;

	getAllDishes(function(){
		getAllUsers(function(users){
			_allUsers = users;
			userObj = users;
			var usersList = document.getElementById('usersList');
			var tbodyElement = usersList.getElementsByTagName('tbody')[0];
			var content = "";
			for (var i = 0; i < userObj.length; i++) {
				var id = userObj[i].id;
				var username = userObj[i].get('username');
				var email = userObj[i].get('email');
				content+= '<tr><td class="usersListClass" style="cursor: pointer"><span value="' + i + 	'" username="'+username+'" email="'+ email + '" id="' + id  + '" >' + username + '</td>' + addText + '</tr>';  
			};
			tbodyElement.innerHTML = content
			newRowAtLast('usersList','New User');
		});
	}, function (){
		console.log("Some error occured");
	}, true); //This is set to true, because

	$(document).on('click', '.removeButton', function(e){
		var $killrow = $(this).closest('tr');
		$killrow.fadeOut(200, function(){
			$(this).remove();
		});
		notifySend('Removed Successfully', 'danger');
	});

	$(document).on('click', '.deleteUser' , function(){
		var $node = $(this).closest("tr").find('span');
		var id = $node.attr('id');
		var email = $node.attr('email');
		bootbox.confirm("Are you sure you want to delete", function(decision){
			if(decision == false)	{
				console.log("No");
				return ;
			}
			else{
				//Deleting the user
				console.log("Deleting user");
				var user = searchItemById(_allUsers, id);
				deleteUser(user, function(){
					notifySend("Successfully deleted ", 'danger');
					setTimeout(function () {
						location.reload();
					}, 750);
				});
				$node.closest('tr').remove();
			}
		});
	});

	$(document).on('click', '.appendInTable', function(){
		var node = $(this).closest('tr');
		bootbox.prompt("Enter the username", function(username){
			if(username == null){
				return ;
			}
			if(username.toString()!=username){
				return ;
			}
			if(validateEmail(username)){
				checkAndAddUser(username, function(user){
					var id = user.id;
					var email = user.get('email');
					var username = user.get('username');
					//Value can be left out for now
					node.before('<tr><td class="usersListClass" style="cursor: pointer"> <span username="' + username + '" email = "' + email + '" id="' + id + '" >' + username + '</td>' + addText + '</tr>');
					notifySend('User Successfully Added', 'info');
					setTimeout(function(){
						location.reload();
					},750)
				}, function(error){
					notifySend('Some error occured', 'warning');
				});
			}
			else{
				notifySend("Please enter a valid email address", 'danger');
			}
		});
	});

	$(document).on('click', '.usersListClass', function(e){
		// editValue($(this));
		var $node = $(this).find('span');
		var username = $node.attr('username');
		var email = $node.attr('email');
		var id = $node.attr('id');
		var index = $node.attr('value');
		$('.selectedUserTopRight').html('<b> ' + email + ' </b>');
		
		currentUser['username'] = username;
		currentUser['email'] = email;
		currentUser['id'] = id;
		currentUser['index'] = index;
		showSuggestiosForUser(username, id);
		showOrdersForUser(username,id)

		//=================== This is remaining, just ask what all arguments to send for getLastOrderOfUser()
		var lastOrder = getLastOrderOfUser({'orders': undefined});
		if(lastOrder){
			var tbody = $("#ordersTable").find('table tbody');
			var content = "";
			for (var i = 0; i < lastOrder.length; i++) {
				var date = lastOrder[i].get('date');
				var id = lastOrder[i].id;
				content+='<tr><td><span id="' + id + '" >' + date + '</td></tr>';
			};
			tbody.html(content);
		}
	});

	$(document).on('click', '.editUserName',function(e){
		text = $(this).closest('tr').find('span').html().trim();
		// selectCurrentDish($(this));
		// editMyDish(text);
		notifySend('Added Successfully', 'info');
	});

//This logic need to be changed completely
$(document).on('click', '.openModal', function(e){
	
	if($("#checkall").val() == 'on'){
		$("#checkall").click();
	}


	var tableType = $(this).closest('div').attr('id');
	console.log(tableType);
	
	if(tableType=='suggestionsTable'){
		var $node = $('#suggestionsModal');
		console.log("hell");

		 //Set title
		 $node.find('#modalTitle').html('Select Dish For Suggestions');
		 var dishes = _allDishes;
		 var modalContent = ""
		 for (var i = 0; i < dishes.length; i++) {
		 	var name = dishes[i].get('name');
		 	var id = dishes[i].id;
		 	modalContent+='<tr>\n<td width="10%"><input type="checkbox" class="checkthis"></td>\n<td class="dishesName" value="' + id + '" index="' + i + '"' + '"> ' + name + '</td>\n</tr>';
		 };
		 $('.modalTableBody').html(modalContent);
		 // display(quantities);
		}
	});

$("#checkall").click(function(){
	var onOrOff = $(this).val();
	if(onOrOff == "off"){
		$('.modalTableBody tr').find('.checkthis').click();
		$(this).val('on');
	}
	else{
		$(this).val('off');
	}
});



$(document).on('click',".changeServings", function(){
	var change;
	if($(this).hasClass("incrementServings")){
		change = 1;
	}
	else{
		change = -1;
	}
	console.log(change);
	$node = $(this).closest('td').find('.servings');
	var servings = $node.html().trim();
	servings = parseInt(servings);
	var finalValue = servings + change;
	console.log(finalValue);
	console.log("hello");
	if(finalValue > 0){
		$node.html(finalValue.toString());
	}
})

$('.selectDishes').click(function(){
	var $allInputs = $('.modalTableBody').find('input[type="checkbox"]:checked');
	$allInputs.each(function(){
		var $node = $(this).closest('tr').find('.dishesName');
		var dishName = $node.html().trim();
		console.log(dishName);
		var id = $node.attr('value');
		console.log(id);
		var index = $node.attr('index');
		addSuggestionsForUser(dishName, id, 'suggestionsTable', 1);
	});
});
$(document).on('click', '.tableCell', function(){
	var id = $(this).find('span').attr('id');
	window.location.href="lastOrder.html?orderId=" + id;
});

$(document).on('click', '.LOGOUT', function(e){
	
	try{
		Parse.User.logout();
	}
	catch(e){

	}
	notifySend("Thanks for using Grocery 2.0", 'warning');
	setTimeout(function(){
		window.location.href="index.html";
	}, 2500);

})

$("#saveButton").click(function(){
	var selectedDishes=[];
	var finalA;
	var user = searchItemById(_allUsers, currentUser['id']);
	var username = currentUser.username
	loginUserForEmail(username, function(){
		$("#suggestionsTable .tableRow").each(function(){
			var id = $(this).find('.tableCell span').attr('id');
			var servingsNumber = parseInt($(this).find('.servings').html().trim());
			var tempSelectDish = createSelectDish(searchItemById(_allDishes, id),servingsNumber);
			selectedDishes.push(tempSelectDish);
			/*tempSelectDish.save({
				success: function(selectDish){
					user.add('suggestion', selectedDishes);
					updateUser(user, function(){
						console.log("Updated dish")
					}, function(){
						console.log("Some error occured in updating");
					});		
				},
				error: function(error){
				}
			});*/
		});

		Parse.Object.saveAll(selectedDishes, {
			success: function(objs){
				finalA = objs;
			//Objects have been saved
			user.set('suggestion', finalA);
			updateUser(user, function(){
				notifySend("Successfully saved", 'info');
			}, function(){
				console.log("Some error occured");
			});
		},
		error: function(error){
			//Error occured
			
		}
	});
	});

	console.log(user);
});

var img = 0;

</script>
</html>
